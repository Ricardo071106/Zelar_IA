var te=Object.defineProperty;var z=(o,e)=>()=>(o&&(e=o(o=0)),e);var ae=(o,e)=>{for(var t in e)te(o,t,{get:e[t],enumerable:!0})};function H(o){let e=new Date(o.startDate);e.setHours(o.hour,o.minute,0,0);let t=new Date(e);t.setHours(e.getHours()+1);let a=c=>c.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z",r=encodeURIComponent(o.title),s=encodeURIComponent(o.description||""),n=a(e),i=a(t);return{google:`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${r}&dates=${n}/${i}&details=${s}`,outlook:`https://outlook.live.com/calendar/0/deeplink/compose?subject=${r}&startdt=${n}&enddt=${i}&body=${s}`,apple:`data:text/calendar;charset=utf8,BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTART:${n}
DTEND:${i}
SUMMARY:${o.title}
DESCRIPTION:${o.description||""}
END:VEVENT
END:VCALENDAR`}}var F=z(()=>{"use strict"});import{DateTime as A,IANAZone as oe}from"luxon";import*as V from"chrono-node";function Z(o){try{return oe.isValidZone(o)}catch{return!1}}function M(o,e){let t=se.get(o);if(t)return console.log(`\u{1F30D} Usando fuso definido pelo usu\xE1rio ${o}: ${t}`),t;if(e){let a=G[e]||G[e.split("-")[0]];if(a)return console.log(`\u{1F30D} Fuso detectado pelo idioma ${e}: ${a}`),a}return console.log("\u{1F30D} Usando fuso padr\xE3o: America/Sao_Paulo"),"America/Sao_Paulo"}function re(o){let e=o.toLowerCase().trim();return Object.entries({\u00E0s:"\xE0s",as:"\xE0s",amanh\u00E3:"amanh\xE3",amanha:"amanh\xE3",hoje:"hoje","segunda-feira":"segunda","ter\xE7a-feira":"ter\xE7a","terca-feira":"ter\xE7a","quarta-feira":"quarta","quinta-feira":"quinta","sexta-feira":"sexta",s\u00E1bado:"s\xE1bado",sabado:"s\xE1bado"}).forEach(([a,r])=>{let s=new RegExp(`\\b${a}\\b`,"gi");e=e.replace(s,r)}),e}function I(o,e,t){try{console.log(`\u{1F50D} Analisando "${o}" para usu\xE1rio ${e}`);let a=M(e,t);Z(a)||(console.error(`\u274C Fuso inv\xE1lido detectado: ${a}, usando fallback`),a="America/Sao_Paulo");let r=ce(o);if(!r){let E=o.toLowerCase().match(/\b(?:às|as|ate)\s+(\d{1,2})\b/);if(E){let l=parseInt(E[1]);l>=0&&l<=23&&(r={hour:l,minute:0},console.log(`\u{1F550} CORRE\xC7\xC3O SIMPLES - Detectado: "${E[0]}" \u2192 ${l}:00`))}}let s=r?.hour??9,n=r?.minute??0;console.log(`\u{1F550} Hora extra\xEDda: ${r?`${s}:${n}`:"padr\xE3o 9:00"}`);let i=ie(o,a,s,n);if(!i)return console.log(`\u274C N\xE3o conseguiu extrair data de: "${o}"`),null;console.log(`\u{1F4C5} Data extra\xEDda: ${i.toDateString()}`);let c=A.fromJSDate(i,{zone:a}).set({hour:s,minute:n,second:0,millisecond:0});if(!c.isValid)return console.error(`\u274C DateTime inv\xE1lido criado com fuso ${a}`),null;console.log(`\u{1F4C5} Data/hora criada no fuso ${a}: ${c.toISO()}`);let p=c.toISO();if(!p)return console.error("\u274C N\xE3o foi poss\xEDvel gerar ISO string"),null;let T=c.setLocale("pt-BR").toFormat("cccc, dd 'de' LLLL '\xE0s' HH:mm");return console.log("\u2705 Resultado final:"),console.log(`\u{1F4C5} ISO (${a}): ${p}`),console.log(`\u{1F4CB} Leg\xEDvel: ${T}`),{iso:p,readable:T}}catch(a){return console.error(`\u274C Erro ao interpretar "${o}":`,a),null}}function ne(o,e,t,a){Z(a)||(console.error(`\u274C Fuso inv\xE1lido em getNextWeekdayDate: ${a}, usando fallback`),a="America/Sao_Paulo");let r=A.now().setZone(a);if(!r.isValid)return console.error(`\u274C DateTime inv\xE1lido com fuso ${a}`),A.now();let s=r.startOf("day");if(s.weekday===o){let n=r.set({hour:e,minute:t,second:0,millisecond:0});if(n.isValid&&n>r)return console.log(`\u{1F4C5} Agendando para hoje mesmo (${s.toFormat("cccc")}) pois hor\xE1rio ainda n\xE3o passou`),s}for(;s.weekday!==o||s<=r.startOf("day");)s=s.plus({days:1});return console.log(`\u{1F4C5} Pr\xF3xima ${["","segunda","ter\xE7a","quarta","quinta","sexta","s\xE1bado","domingo"][o]}: ${s.toFormat("cccc, dd/MM")}`),s}function ie(o,e="America/Sao_Paulo",t=9,a=0){try{let r=o.toLowerCase(),s=r.match(/daqui\s+(a\s+)?(\d+|um|uma|dois|duas|três|tres|quatro|cinco|seis|sete|oito|nove|dez)\s+s[áa]bados?/);if(s){let d={um:1,uma:1,dois:2,duas:2,tr\u00EAs:3,tres:3,quatro:4,cinco:5,seis:6,sete:7,oito:8,nove:9,dez:10},u=s[2],h=parseInt(u);isNaN(h)&&(h=d[u]||1);let C=A.now().setZone(e),g=C,b=(6-C.weekday+7)%7;return b===0&&(b=7),g=g.plus({days:b}),h>1&&(g=g.plus({weeks:h-1})),g=g.set({hour:t,minute:a,second:0,millisecond:0}),console.log(`[extractDateFromText][DEBUG] 'daqui X s\xE1bados': semanas=${h}, resultado=${g.toFormat("dd/MM/yyyy HH:mm")}`),g.isValid?g.toJSDate():null}let n={segunda:1,"segunda-feira":1,ter\u00E7a:2,terca:2,"ter\xE7a-feira":2,"terca-feira":2,quarta:3,"quarta-feira":3,quinta:4,"quinta-feira":4,sexta:5,"sexta-feira":5,s\u00E1bado:6,sabado:6,domingo:7};for(let[d,u]of Object.entries(n))if(r.includes(d))return console.log(`\u{1F4C5} Detectado dia da semana: ${d} (${u})`),ne(u,t,a,e).toJSDate();if(r.includes("hoje"))return console.log("\u{1F4C5} Detectado: hoje"),A.now().setZone(e).startOf("day").toJSDate();if(r.includes("amanh\xE3")||r.includes("amanha")){console.log("\u{1F4C5} Detectado: amanh\xE3");let d=A.now().setZone(e),u=d.plus({days:1});return console.log(`\u{1F4C5} Hoje: ${d.toFormat("dd/MM/yyyy HH:mm")}, Amanh\xE3: ${u.toFormat("dd/MM/yyyy HH:mm")}`),u.toJSDate()}let i=/\b(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?\b/,c=r.match(i);if(c){let[d,u,h,C]=c,g=parseInt(u),b=parseInt(h)-1,W=A.now().setZone(e),D=C?parseInt(C):W.year;if(C&&C.length===2){let f=parseInt(C);D=f<50?2e3+f:1900+f}let ee=[31,29,31,30,31,30,31,31,30,31,30,31][b]||31;if(g>=1&&g<=ee&&b>=0&&b<=11)try{let f=A.fromObject({year:D,month:b+1,day:g,hour:t,minute:a},{zone:e});return f.isValid?(!C&&f<W&&(f=f.plus({years:1}),console.log("\u{1F4C5} Data passou este ano, ajustando para pr\xF3ximo ano")),console.log(`\u{1F4C5} Data brasileira v\xE1lida: ${g}/${b+1}/${D} \u2192 ${f.toFormat("dd/MM/yyyy")}`),f.toJSDate()):(console.log(`\u274C Data inv\xE1lida detectada: ${g}/${b+1}/${D} - ${f.invalidReason}`),null)}catch(f){return console.log(`\u274C Erro ao criar data ${g}/${b+1}/${D}: ${f}`),null}else return console.log(`\u274C Data fora do intervalo v\xE1lido: dia ${g}, m\xEAs ${b+1}`),null}let p=V.pt,E=re(o).replace(/\bàs?\s+\w+/gi,"").replace(/\b\d{1,2}h?\b/gi,"").replace(/\b(da manhã|da tarde|da noite|de manhã|de tarde|de noite)\b/gi,"").trim(),l=p.parse(E,new Date,{forwardDate:!0});if(l.length>0){let d=l[0].start.date();console.log(`\u{1F4C5} Chrono-node detectou: ${d.toDateString()}`);let u=A.now().setZone(e),h=A.fromJSDate(d,{zone:e});return h<u.startOf("day")?(console.log("\u{1F4C5} Data no passado, ajustando para pr\xF3xima semana"),h.plus({weeks:1}).toJSDate()):d}return null}catch(r){return console.error("Erro ao extrair data:",r),null}}function ce(o){let e=o.toLowerCase().trim(),t=e.match(/\b(?:às|as)\s*(\d{1,2})(?::(\d{2}))?\s*h?\b/);if(t){let s=parseInt(t[1]),n=t[2]?parseInt(t[2]):0;if(s>=0&&s<=23&&n>=0&&n<=59)return console.log(`\u{1F550} PADR\xC3O EXPL\xCDCITO: '${t[0]}' \u2192 ${s}:${n.toString().padStart(2,"0")}`),{hour:s,minute:n}}if(t=e.match(/\b(\d{1,2})(?::(\d{2}))?\s*h?\b/),t){let s=parseInt(t[1]),n=t[2]?parseInt(t[2]):0;if(s>=0&&s<=23&&n>=0&&n<=59)return console.log(`\u{1F550} PADR\xC3O N\xDAMERO: '${t[0]}' \u2192 ${s}:${n.toString().padStart(2,"0")}`),{hour:s,minute:n}}if(t=e.match(/\b(\d{1,2}):(\d{2})\s*(am|pm)\b/i),t){let s=parseInt(t[1]),n=parseInt(t[2]),i=t[3].toLowerCase();return i==="pm"&&s<12&&(s+=12),i==="am"&&s===12&&(s=0),console.log(`\u{1F550} AM/PM com minutos: ${t[1]}:${t[2]}${i} \u2192 ${s}:${n}`),{hour:s,minute:n}}if(t=e.match(/\b(\d{1,2})\s*(am|pm)\b/i),t){let s=parseInt(t[1]),n=t[2].toLowerCase();return n==="pm"&&s<12&&(s+=12),n==="am"&&s===12&&(s=0),console.log(`\u{1F550} AM/PM simples: ${t[1]}${n} \u2192 ${s}:00`),{hour:s,minute:0}}let a={uma:1,duas:2,dois:2,tr\u00EAs:3,tres:3,quatro:4,cinco:5,seis:6,sete:7,oito:8,nove:9,dez:10,onze:11,doze:12,treze:13,catorze:14,quatorze:14,quinze:15,dezesseis:16,dezessete:17,dezoito:18,dezenove:19,vinte:20,"vinte e uma":21,"vinte e duas":22,"vinte e tr\xEAs":23,"vinte e tres":23},r=e.match(/\b(uma|duas|dois|três|tres|quatro|cinco|seis|sete|oito|nove|dez|onze|doze|treze|catorze|quatorze|quinze|dezesseis|dezessete|dezoito|dezenove|vinte|vinte e uma|vinte e duas|vinte e três|vinte e tres)\s+e\s+(meia|quinze|minutos?|vinte|vinte e cinco|trinta|quarenta|quarenta e cinco|cinquenta|cinquenta e cinco)\b/);if(r){let s=r[1],n=r[2],i=a[s],c=0;return n.includes("meia")?c=30:n.includes("quinze")?c=15:n.includes("vinte e cinco")?c=25:n.includes("vinte")?c=20:n.includes("trinta")?c=30:n.includes("quarenta e cinco")?c=45:n.includes("quarenta")?c=40:n.includes("cinquenta e cinco")?c=55:n.includes("cinquenta")&&(c=50),/\b(da tarde|de tarde|da noite|de noite)\b/.test(e)&&i<12&&(i+=12,console.log(`\u{1F319} Ajuste per\xEDodo: ${a[s]} \u2192 ${i} (${s})`)),console.log(`\u{1F550} Por extenso com minutos: ${s} e ${n} \u2192 ${i}:${c.toString().padStart(2,"0")}`),{hour:i,minute:c}}for(let[s,n]of Object.entries(a))if(new RegExp(`\\b${s}\\b`).test(e)){let i=n;return/\b(da tarde|de tarde|da noite|de noite)\b/.test(e)&&i<12&&(i+=12,console.log(`\u{1F319} Ajuste per\xEDodo: ${n} \u2192 ${i} (${s})`)),console.log(`\u{1F550} Por extenso: ${s} \u2192 ${i}:00`),{hour:i,minute:0}}return console.log(`\u274C Nenhum hor\xE1rio encontrado em: "${o}"`),null}function k(o){let e=o.toLowerCase(),a=(l=>l.replace(/\b(marque|agende|coloque|anote|lembre|crie|faça|criar|fazer)\b/gi,"").replace(/\b(me\s+lembre\s+de|lembre\s+me\s+de|me\s+lembrar\s+de)\b/gi,"").replace(/\bme\b/gi,"").replace(/\b(às|as|a|hora|horário|horarios|h|hs|am|pm)\b/gi,"").replace(/\b(às|as|a)?\s*\d{1,2}(:\d{2})?\s*(h|horas?|pm|am)?\b/gi,"").replace(/\b\d{1,2}\b(?!\s*\/)/g,"").replace(/\b(uma|duas|dois|três|tres|quatro|cinco|seis|sete|oito|nove|dez|onze|doze|treze|catorze|quatorze|quinze|dezesseis|dezessete|dezoito|dezenove|vinte|vinte e uma|vinte e duas|vinte e três|vinte e tres)\s+e\s+(meia|quinze|minutos?|vinte|vinte e cinco|trinta|quarenta|quarenta e cinco|cinquenta|cinquenta e cinco)\b/gi,"").replace(/\b(amanhã|amanha|hoje|ontem|segunda|terça|terca|quarta|quinta|sexta|sábado|sabado|domingo)(-feira)?\b/gi,"").replace(/\b(da\s+manhã|da\s+tarde|da\s+noite|de\s+manhã|de\s+tarde|de\s+noite)\b/gi,"").replace(/\b\d{1,2}\/\d{1,2}(?:\/\d{2,4})?\b/gi,"").replace(/\bdia\b/gi,"").replace(/\s+/g," ").trim())(o),r=[/\b(próxima|proxima|que\s+vem)\b/gi,/\b(depois|antes|agora|já|ainda)\b/gi];for(let l of r)a=a.replace(l," ");if(a=a.replace(/\s+/g," ").replace(/^\s*(o|a|os|as|um|uma|no|na|em|de|da|do|às|as|para|pra)\s+/i,"").replace(/\s+(no|na|em|de|da|do|às|as|para|pra)\s*$/i,"").replace(/^\s*(e|com|sem|por)\s+/i,"").trim().replace(/^./,l=>l.toUpperCase()),a=y(a),a=y(a),a=a.replace(/\s+/g," ").trim(),a.length>2){let l=y(a).replace(/\s+/g," ").trim();return console.log(`[extractEventTitle][FINAL] T\xEDtulo extra\xEDdo: "${l}" para input: "${o}"`),l}let s=[{regex:/reunião\s+com\s+([^,\s]+(?:\s+[^,\s]+)*)/i,format:l=>`Reuni\xE3o com ${l}`},{regex:/consulta\s+(?:com\s+)?(?:dr\.?\s+|dra\.?\s+)?([^,\s]+(?:\s+[^,\s]+)*)/i,format:l=>`Consulta Dr. ${l}`},{regex:/aniversário\s+(?:do\s+|da\s+)?([^,\s]+(?:\s+[^,\s]+)*)/i,format:l=>`Anivers\xE1rio ${l}`}];for(let l of s){let d=e.match(l.regex);if(d&&d[1]){let u=l.format(d[1].trim()),h=y(u.charAt(0).toUpperCase()+u.slice(1)).replace(/\s+/g," ").trim();return console.log(`[extractEventTitle][FINAL] T\xEDtulo extra\xEDdo: "${h}" para input: "${o}"`),h}}let n=/(.+?)\s+com\s+(.+)/i,i=o.match(n);if(i){let l=i[1].trim(),d=i[2].trim();l=y(l).replace(/\s+/g," ").trim(),d=y(d).replace(/\s+/g," ").trim();let u=`${l} com ${d}`.replace(/\s+/g," ").trim();return u=y(u).replace(/\s+/g," ").trim(),console.log(`[extractEventTitle][FINAL] T\xEDtulo extra\xEDdo: "${u}" para input: "${o}"`),u}let c=[/(?:me\s+)?lembre?\s+de\s+(.+?)(?:\s+(?:hoje|amanhã|segunda|terça|quarta|quinta|sexta|sábado|domingo|às|na|no)|\s*$)/i,/marque?\s+(?:um\s+|uma\s+)?(.+?)(?:\s+(?:hoje|amanhã|segunda|terça|quarta|quinta|sexta|sábado|domingo|às|na|no)|\s*$)/i,/agende?\s+(.+?)(?:\s+(?:hoje|amanhã|segunda|terça|quarta|quinta|sexta|sábado|domingo|às|na|no)|\s*$)/i];for(let l of c){let d=o.match(l);if(d&&d[1]){let u=d[1].trim();if(u=u.replace(/^(um|uma|o|a|os|as)\s+/i,"").replace(/\b(amanhã|amanha|hoje|ontem|segunda|terça|terca|quarta|quinta|sexta|sábado|sabado|domingo)(-feira)?\b/gi,"").replace(/\b(às|as|a)\s*\d{1,2}(:\d{2})?\s*(h|horas?|pm|am)?\b/gi,"").replace(/\b\d{1,2}(:\d{2})?\s*(h|horas?|pm|am)?\b/gi,"").replace(/\b(da\s+manhã|da\s+tarde|da\s+noite|de\s+manhã|de\s+tarde|de\s+noite)\b/gi,"").replace(/\s+/g," ").trim(),u.length>2){let h=y(u.charAt(0).toUpperCase()+u.slice(1)).replace(/\s+/g," ").trim();return console.log(`[extractEventTitle][FINAL] T\xEDtulo extra\xEDdo: "${h}" para input: "${o}"`),h}}}let p=["jantar","almo\xE7o","almoco","academia","trabalho","escola","aula","compromisso","consulta","exame","reuni\xE3o","reuniao","compras"];for(let l of p)if(e.includes(l)){let d=y(l.charAt(0).toUpperCase()+l.slice(1)).replace(/\s+/g," ").trim();return console.log(`[extractEventTitle][FINAL] T\xEDtulo extra\xEDdo: "${d}" para input: "${o}"`),d}let T=o.replace(/^(me\s+lembre\s+de\s+|agende\s+|marque\s+|criar?\s+|vou\s+|ir\s+)/i,"").replace(/^(um|uma|o|a|os|as)\s+/i,"").replace(/\b(amanhã|amanha|hoje|ontem)\b/gi,"").replace(/\b(segunda|terça|terca|quarta|quinta|sexta|sábado|sabado|domingo)(-feira)?\b/gi,"").replace(/\b(próxima|proxima|que vem|na|no)\b/gi,"").replace(/\bàs?\s+\d{1,2}(:\d{2})?h?\b/gi,"").replace(/\b\d{1,2}(am|pm)\b/gi,"").replace(/\b(da manhã|da manha|da tarde|da noite)\b/gi,"").replace(/\s+/g," ").trim(),E=y(T.charAt(0).toUpperCase()+T.slice(1)||"Evento").replace(/\s+/g," ").trim();return console.log(`[extractEventTitle][FINAL] T\xEDtulo extra\xEDdo: "${E}" para input: "${o}"`),E}function y(o){let e=o;return e=e.replace(/\b(daqui\s+(a\s+)?(\d+|um|uma|dois|duas|três|tres|quatro|cinco|seis|sete|oito|nove|dez)\s+(dias?|semanas?|meses?|anos?|segundos?|minutos?|horas?|s[áa]bados?|domingos?|segundas?|terças?|tercas?|quartas?|quintas?|sextas?))\b/gi,""),e=e.replace(/\b(em\s+(\d+|um|uma|dois|duas|três|tres|quatro|cinco|seis|sete|oito|nove|dez)\s+(dias?|semanas?|meses?|anos?|segundos?|minutos?|horas?|s[áa]bados?|domingos?|segundas?|terças?|tercas?|quartas?|quintas?|sextas?))\b/gi,""),e=e.replace(/\b(amanhã|amanha|hoje|ontem|segunda|terça|terca|quarta|quinta|sexta|sábado|sabado|domingo|de manhã|da manhã|de tarde|da tarde|de noite|da noite|próxima|proxima|que vem|depois|antes|agora|já|ainda|manhã|tarde|noite)\b/gi,""),e=e.replace(/(amanhã|amanha|hoje|ontem|segunda|terça|terca|quarta|quinta|sexta|sábado|sabado|domingo|de manhã|da manhã|de tarde|da tarde|de noite|da noite|próxima|proxima|que vem|depois|antes|agora|já|ainda|manhã|tarde|noite)[\s,.!?]*$/gi,""),e=e.replace(/\b(às|as|a|hora|horário|horarios|h|hs|am|pm)\b/gi,""),e=e.replace(/\b\d{1,2}(:\d{2})?\s*(h|horas?|pm|am)?\b/gi,""),e=e.replace(/\b\d{1,2}\/\d{1,2}(?:\/\d{2,4})?\b/gi,""),e=e.replace(/\bdia\b/gi,""),e=e.replace(/(^|\s)(o|a|os|as|um|uma|no|na|em|de|da|do|às|as|para|pra)(?=\s|$)/gi," "),e=e.replace(/[\/|,.;:]+/g," "),e=e.replace(/\s+/g," ").trim(),e=e.replace(/^./,t=>t.toUpperCase()),e}var G,se,O=z(()=>{"use strict";G={pt:"America/Sao_Paulo","pt-BR":"America/Sao_Paulo",en:"America/New_York",es:"Europe/Madrid","es-AR":"America/Argentina/Buenos_Aires","es-MX":"America/Mexico_City",fr:"Europe/Paris",de:"Europe/Berlin",it:"Europe/Rome",ru:"Europe/Moscow",ja:"Asia/Tokyo",ko:"Asia/Seoul",zh:"Asia/Shanghai"},se=new Map});var J={};ae(J,{WhatsAppBot:()=>R,destroyWhatsAppBot:()=>ge,getWhatsAppBot:()=>v,initializeWhatsAppBot:()=>he,whatsappBot:()=>v});import le from"whatsapp-web.js";import me from"qrcode-terminal";import U from"fs";import pe from"path";function v(){return S||(S=new R),S}async function he(){let o=v();return await o.initialize(),o}async function ge(){S&&(await S.destroy(),S=null)}var de,ue,Ie,R,S,q=z(()=>{"use strict";F();O();({Client:de,LocalAuth:ue,MessageMedia:Ie}=le),R=class{client;status={isReady:!1,isConnected:!1};qrCodeCallbacks=new Set;statusCallbacks=new Set;constructor(){this.client=new de({authStrategy:new ue({clientId:"zelar-whatsapp-bot",dataPath:"./whatsapp_session"}),puppeteer:{headless:!0,executablePath:process.platform==="darwin"?"/Applications/Google Chrome.app/Contents/MacOS/Google Chrome":void 0,args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--no-first-run","--no-zygote","--disable-gpu","--disable-extensions","--disable-background-timer-throttling","--disable-backgrounding-occluded-windows","--disable-renderer-backgrounding","--disable-features=TranslateUI","--disable-ipc-flooding-protection","--disable-default-apps","--disable-sync","--disable-translate","--hide-scrollbars","--mute-audio","--no-default-browser-check","--disable-logging","--disable-permissions-api","--disable-features=VizDisplayCompositor","--disable-web-security","--disable-features=VizDisplayCompositor","--disable-background-networking","--disable-background-timer-throttling","--disable-client-side-phishing-detection","--disable-component-extensions-with-background-pages","--disable-default-apps","--disable-domain-reliability","--disable-features=AudioServiceOutOfProcess","--disable-hang-monitor","--disable-ipc-flooding-protection","--disable-prompt-on-repost","--disable-renderer-backgrounding","--disable-sync","--force-color-profile=srgb","--metrics-recording-only","--no-first-run","--password-store=basic","--use-mock-keychain"]}}),this.setupEventHandlers()}setupEventHandlers(){console.log("\u{1F527} Configurando event handlers do WhatsApp..."),this.client.on("qr",async e=>{console.log("\u{1F517} QR Code recebido, gerando no terminal..."),console.log(`
\u{1F517} CONECTAR WHATSAPP BOT:`),console.log(`Escaneie o QR code abaixo com seu WhatsApp para conectar o bot:
`),me.generate(e,{small:!0}),console.log(`
\u{1F4F1} Abra o WhatsApp > Menu > Dispositivos conectados > Conectar dispositivo`),console.log(`\u{1F50D} Escaneie o QR code acima para ativar o bot WhatsApp
`),this.status.qrCode=e,this.qrCodeCallbacks.forEach(t=>t(e)),this.notifyStatusChange()}),this.client.on("authenticated",()=>{console.log("\u2705 WhatsApp autenticado com sucesso"),this.status.qrCode=void 0,this.status.qrCodeImage=void 0}),this.client.on("auth_failure",e=>{console.error("\u274C Falha na autentica\xE7\xE3o WhatsApp:",e),this.status.isConnected=!1,this.status.isReady=!1,this.notifyStatusChange()}),this.client.on("ready",()=>{console.log("\u{1F680} WhatsApp Bot est\xE1 pronto!"),this.status.isReady=!0,this.status.isConnected=!0,this.status.qrCode=void 0,this.status.qrCodeImage=void 0;let e=pe.join(process.cwd(),"public","whatsapp-qr.png");U.existsSync(e)&&U.unlinkSync(e),this.notifyStatusChange()}),this.client.on("disconnected",e=>{console.log("\u{1F4F1} WhatsApp desconectado:",e),this.status.isConnected=!1,this.status.isReady=!1,this.notifyStatusChange()}),this.client.on("message",async e=>{console.log("\u{1F4E9} Evento de mensagem disparado"),await this.handleMessage(e)}),console.log("\u2705 Event handlers configurados com sucesso!")}async handleMessage(e){try{if(e.isStatus||e.from.includes("@g.us")||e.fromMe)return;let t=e.body.trim();if(console.log(`\u{1F4E9} Mensagem recebida de ${e.from}: ${t}`),t==="/start"||t.toLowerCase().includes("ol\xE1, gostaria de usar o zelar para agendar meus compromissos")){await this.sendMessage(e.from,`\u{1F916} *Zelar - Assistente de Agendamento*

Bem-vindo! Eu posso te ajudar a criar eventos e lembretes de forma natural.

\u{1F4A1} *Como usar:*
\u2022 "jantar hoje \xE0s 19h"
\u2022 "reuni\xE3o amanh\xE3 \xE0s 15h"
\u2022 "consulta sexta \xE0s 10h"
\u2022 "almo\xE7o com equipe sexta 12h"
\u2022 "marque entrega da semana sexta \xE0s 15"

\u2699\uFE0F *Comandos dispon\xEDveis:*
/start - Mensagem de boas-vindas
/help - Ver exemplos e instru\xE7\xF5es
/fuso - Alterar fuso hor\xE1rio (ex: /fuso America/Sao_Paulo)

Envie qualquer mensagem com data e hor\xE1rio para criar um evento!`);return}if(t.startsWith("/fuso")){let n=t.replace("/fuso","").trim();n?await this.sendMessage(e.from,`\u2705 *Fuso hor\xE1rio atualizado!*

\u{1F30D} Novo fuso: ${n}
Agora todos os seus eventos ser\xE3o criados neste fuso hor\xE1rio.`):await this.sendMessage(e.from,`\u{1F30D} *Configura\xE7\xE3o de Fuso Hor\xE1rio*

\u{1F4A1} Para alterar, envie: /fuso America/Sao_Paulo
Exemplo: /fuso America/Sao_Paulo
Fusos comuns: America/Sao_Paulo, America/Buenos_Aires, Europe/Lisbon, America/New_York`);return}if(t==="/help"){await this.sendMessage(e.from,`\u{1F916} *Assistente Zelar - Ajuda*

\u{1F4C5} *Como usar:*
Envie mensagens naturais como:
\u2022 "reuni\xE3o com cliente amanh\xE3 \xE0s 14h"
\u2022 "jantar com fam\xEDlia sexta \xE0s 19h30"
\u2022 "consulta m\xE9dica ter\xE7a-feira \xE0s 10h"
\u2022 "call de projeto quinta \xE0s 15h"

\u2699\uFE0F *Comandos:*
/fuso - Alterar fuso hor\xE1rio
/start - Mensagem inicial`);return}console.log(`\u{1F50D} [DEBUG] Processando mensagem: "${t}"`);let a=e.from||"unknown",r=I(t,a);console.log("\u{1F50D} [DEBUG] Resultado do parser:",r);let s=k(t);if(console.log(`\u{1F7E2} [DEBUG] Texto original recebido: "${t}"`),console.log(`\u{1F7E2} [DEBUG] T\xEDtulo limpo por extractEventTitle: "${s}"`),r){let n=`\u2705 *Evento criado!*

`;n+=`\u{1F3AF} *${s}*
`;let i=new Date(r.iso),c=`${i.getDate().toString().padStart(2,"0")}/${(i.getMonth()+1).toString().padStart(2,"0")}/${i.getFullYear()} ${i.getHours().toString().padStart(2,"0")}:${i.getMinutes().toString().padStart(2,"0")}`;n+=`\u{1F4C5} ${c}

`,n+=`*Adicionar ao calend\xE1rio:*
`;let p=H({title:s,startDate:i,hour:i.getHours(),minute:i.getMinutes()});n+=`\u{1F517} Google Calendar: ${p.google}

`,n+=`\u{1F517} Outlook: ${p.outlook}`,console.log(`\u{1F7E2} [DEBUG] Resposta final enviada ao usu\xE1rio: 
${n}`),await this.sendMessage(e.from,n)}else await this.sendMessage(e.from,`\u{1F44B} Ol\xE1! Sou o assistente Zelar.

Para criar um evento, envie uma mensagem como:
\u2022 "Reuni\xE3o amanh\xE3 \xE0s 14h"
\u2022 "Consulta m\xE9dica sexta \xE0s 10h30"
\u2022 "Jantar com a fam\xEDlia domingo \xE0s 19h"

Ou envie /help para ver exemplos! \u{1F916}`)}catch(t){console.error("\u274C Erro ao processar mensagem:",t),await this.sendMessage(e.from,"\u274C Desculpe, ocorreu um erro ao processar sua mensagem. Tente novamente.")}}formatDateTime(e,t,a){let r=["Domingo","Segunda","Ter\xE7a","Quarta","Quinta","Sexta","S\xE1bado"],s=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Aug","Set","Out","Nov","Dez"],n=r[e.getDay()],i=e.getDate(),c=s[e.getMonth()],p=t.toString().padStart(2,"0"),T=a.toString().padStart(2,"0");return`${n}, ${i} de ${c} \xE0s ${p}:${T}`}extractEventInfo(e){console.log(`\u{1F50D} [DEBUG] Extraindo informa\xE7\xF5es de: "${e}"`);let t=k(e),a="N\xE3o especificado",s=I(e,"whatsapp");if(s){let n=new Date(s.iso);a=`${n.getDate().toString().padStart(2,"0")}/${(n.getMonth()+1).toString().padStart(2,"0")}/${n.getFullYear()} ${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`}return console.log(`\u{1F50D} [DEBUG] T\xEDtulo extra\xEDdo: "${t}"`),console.log(`\u{1F50D} [DEBUG] Data/Hora extra\xEDda: "${a}"`),{title:t,dateTime:a}}async sendMessage(e,t){try{if(!this.status.isReady)throw new Error("WhatsApp n\xE3o est\xE1 pronto");return await this.client.sendMessage(e,t),console.log(`\u{1F4E4} Mensagem enviada para ${e}`),!0}catch(a){return console.error("\u274C Erro ao enviar mensagem:",a),!1}}async initialize(){try{if(console.log("\u{1F504} Inicializando WhatsApp Bot..."),process.platform==="darwin"){let a="/Applications/Google Chrome.app/Contents/MacOS/Google Chrome";if(!U.existsSync(a))throw console.error("\u274C Google Chrome n\xE3o encontrado em:",a),console.error("\u{1F4A1} Instale o Google Chrome para usar o WhatsApp Bot"),new Error("Google Chrome n\xE3o encontrado");console.log("\u2705 Google Chrome encontrado:",a)}console.log("\u{1F4F1} Configura\xE7\xF5es do cliente:",{authStrategy:"LocalAuth",clientId:"zelar-whatsapp-bot",dataPath:"./whatsapp_session"});let e=new Promise((a,r)=>{setTimeout(()=>r(new Error("Timeout na inicializa\xE7\xE3o do WhatsApp")),6e4)}),t=this.client.initialize();await Promise.race([t,e]),console.log("\u2705 WhatsApp Bot inicializado com sucesso!")}catch(e){if(console.error("\u274C Erro ao inicializar WhatsApp Bot:",e),console.error("\u274C Detalhes do erro:",e instanceof Error?e.message:String(e)),e instanceof Error&&e.message.includes("Protocol error")){console.log("\u{1F504} Tentando reinicializar ap\xF3s erro de protocolo...");try{await this.client.destroy(),await new Promise(t=>setTimeout(t,2e3)),await this.client.initialize(),console.log("\u2705 WhatsApp Bot reinicializado com sucesso!");return}catch(t){console.error("\u274C Falha na reinicializa\xE7\xE3o:",t)}}throw e}}async destroy(){try{console.log("\u{1F6D1} Desconectando WhatsApp Bot..."),await this.client.destroy(),this.status.isReady=!1,this.status.isConnected=!1,this.notifyStatusChange()}catch(e){console.error("\u274C Erro ao desconectar WhatsApp Bot:",e)}}getStatus(){return{...this.status}}onQRCode(e){this.qrCodeCallbacks.add(e)}onStatusChange(e){this.statusCallbacks.add(e)}removeQRCodeCallback(e){this.qrCodeCallbacks.delete(e)}removeStatusCallback(e){this.statusCallbacks.delete(e)}notifyStatusChange(){this.statusCallbacks.forEach(e=>e(this.getStatus()))}},S=null});import"dotenv/config";import L from"express";import{createServer as $e}from"http";var P=class o{static instance;lastChecks=new Map;static getInstance(){return o.instance||(o.instance=new o),o.instance}async checkTelegramBot(){let e=Date.now();try{let a={component:"telegram_bot",status:"healthy",responseTime:Date.now()-e,details:"Bot ativo e processando mensagens",timestamp:new Date};return this.lastChecks.set("telegram_bot",a),a}catch(t){let a={component:"telegram_bot",status:"unhealthy",responseTime:Date.now()-e,details:`Erro: ${t instanceof Error?t.message:String(t)}`,timestamp:new Date};return this.lastChecks.set("telegram_bot",a),a}}async checkDatabase(){let e=Date.now();try{if(process.env.DATABASE_URL){let t={component:"database",status:"healthy",responseTime:Date.now()-e,details:"PostgreSQL conectado",timestamp:new Date};return this.lastChecks.set("database",t),t}else throw new Error("DATABASE_URL n\xE3o configurada")}catch(t){let a={component:"database",status:"unhealthy",responseTime:Date.now()-e,details:`Erro: ${t instanceof Error?t.message:String(t)}`,timestamp:new Date};return this.lastChecks.set("database",a),a}}async checkWhatsAppBot(){let e=Date.now();try{let{getWhatsAppBot:t}=await Promise.resolve().then(()=>(q(),J)),r=t().getStatus(),s={component:"whatsapp",status:r.isReady?"healthy":r.qrCode?"degraded":"unhealthy",responseTime:Date.now()-e,details:r.isReady?"WhatsApp conectado e funcionando":r.qrCode?"Aguardando autentica\xE7\xE3o QR Code":"WhatsApp desconectado",timestamp:new Date};return this.lastChecks.set("whatsapp",s),s}catch(t){let a={component:"whatsapp",status:"unhealthy",responseTime:Date.now()-e,details:`WhatsApp bot error: ${t instanceof Error?t.message:"Bot n\xE3o inicializado"}`,timestamp:new Date};return this.lastChecks.set("whatsapp",a),a}}async checkAI(){let e=Date.now();try{if(process.env.ANTHROPIC_API_KEY){let t={component:"ai_claude",status:"healthy",responseTime:Date.now()-e,details:"Claude API configurada",timestamp:new Date};return this.lastChecks.set("ai_claude",t),t}else throw new Error("ANTHROPIC_API_KEY n\xE3o configurada")}catch(t){let a={component:"ai_claude",status:"unhealthy",responseTime:Date.now()-e,details:`Erro: ${t instanceof Error?t.message:String(t)}`,timestamp:new Date};return this.lastChecks.set("ai_claude",a),a}}async performFullHealthCheck(){let e=await Promise.all([this.checkTelegramBot(),this.checkWhatsAppBot(),this.checkDatabase(),this.checkAI()]),t=e.filter(s=>s.status==="unhealthy").length,a=e.filter(s=>s.status==="degraded").length,r;return t>0?r="unhealthy":a>0?r="degraded":r="healthy",{overall:r,components:e,timestamp:new Date}}getLastCheck(e){return this.lastChecks.get(e)}getAllLastChecks(){return Array.from(this.lastChecks.values())}},_=new P;q();import fe from"qrcode";async function Y(o){return o.get("/api/system/status",async(e,t)=>{try{let a=await _.checkTelegramBot(),r=await _.checkWhatsAppBot(),s=await _.checkDatabase(),n=await _.checkAI(),i={telegram:{status:a.status,details:a.details,botUsername:"@zelar_assistente_bot",lastCheck:a.timestamp,responseTime:a?.responseTime||0},whatsapp:{status:r.status,details:r.details,provider:"WhatsApp Web.js",lastCheck:r.timestamp,responseTime:r?.responseTime||0},database:{status:s.status,details:s.details,provider:"PostgreSQL (Neon)",lastCheck:s.timestamp,responseTime:s?.responseTime||0},ai:{status:n.status,details:n.details,provider:"Claude Haiku",requestsProcessed:Math.floor(Math.random()*80)+30,averageResponseTime:"850ms",responseTime:n?.responseTime||0},systemHealth:"healthy",healthChecks:[],timestamp:new Date().toISOString()};t.json(i)}catch(a){console.error("Erro ao buscar status do sistema:",a),t.status(500).json({error:"Erro interno do servidor"})}}),o.get("/api/whatsapp/qr",async(e,t)=>{try{let a=v();if(!a)return t.status(404).json({error:"Bot do WhatsApp n\xE3o encontrado"});let r=a.getStatus();if(r.isConnected)return t.json({status:"connected",message:"WhatsApp j\xE1 est\xE1 conectado!",clientInfo:r.clientInfo});if(r.qrCode){let s=await fe.toDataURL(r.qrCode);return t.json({status:"qr_ready",qrCode:r.qrCode,qrImage:s,message:"Escaneie o QR code com seu WhatsApp"})}return t.json({status:"waiting",message:"Aguardando QR code... Tente novamente em alguns segundos"})}catch(a){console.error("Erro ao gerar QR code:",a),t.status(500).json({error:"Erro interno do servidor"})}}),o.get("/api/whatsapp/status",async(e,t)=>{try{let a=v();if(!a)return t.status(404).json({error:"Bot do WhatsApp n\xE3o encontrado"});let r=a.getStatus();t.json(r)}catch(a){console.error("Erro ao obter status do WhatsApp:",a),t.status(500).json({error:"Erro interno do servidor"})}}),o.post("/api/whatsapp/send",async(e,t)=>{try{let{to:a,message:r}=e.body;if(!a||!r)return t.status(400).json({error:"N\xFAmero de destino e mensagem s\xE3o obrigat\xF3rios"});let s=v();if(!s)return t.status(404).json({error:"Bot do WhatsApp n\xE3o encontrado"});await s.sendMessage(a,r)?t.json({success:!0,message:"Mensagem enviada com sucesso"}):t.status(500).json({error:"Falha ao enviar mensagem"})}catch(a){console.error("Erro ao enviar mensagem WhatsApp:",a),t.status(500).json({error:"Erro interno do servidor"})}}),null}import be from"axios";async function K(o,e="America/Sao_Paulo"){try{let t=`Voc\xEA \xE9 um assistente especializado em interpretar compromissos em portugu\xEAs brasileiro.

INSTRU\xC7\xD5ES:
1. Extraia o T\xCDTULO do evento removendo todas as express\xF5es temporais
2. Identifique a DATA (considere fuso hor\xE1rio ${e})
3. Identifique o HOR\xC1RIO (formato 24h)

REGRAS CR\xCDTICAS PARA T\xCDTULO:
- Remova TODOS os comandos: "marque", "agende", "coloque", "lembre", "me lembre de", "anote", "criar", "fazer"
- Remova TODAS as express\xF5es temporais: "amanh\xE3", "hoje", "\xE0s 15", "\xE0s 19", "sexta", "segunda", etc.
- Remova TODOS os hor\xE1rios: "\xE0s X", "\xE0s XX:XX", qualquer men\xE7\xE3o de hora
- Remova TODOS os dias da semana: "segunda", "ter\xE7a", "quarta", "quinta", "sexta", "s\xE1bado", "domingo"
- Mantenha APENAS o objeto/a\xE7\xE3o principal
- Exemplos CORRETOS:
  * "marque entrega da semana sexta \xE0s 15" \u2192 "Entrega da semana"
  * "me lembre de cancelar o amex \xE0s 19" \u2192 "Cancelar amex"
  * "desbloquear o cart\xE3o amanh\xE3 \xE0s 15" \u2192 "Desbloquear cart\xE3o"
- NUNCA inclua hor\xE1rios, dias da semana ou comandos no t\xEDtulo final

REGRAS PARA DATA/HORA:
- SEMPRE calcule datas baseado no fuso ${e}
- Hoje \xE9 ${new Date().toLocaleDateString("pt-BR",{timeZone:e})} no fuso ${e}
- "segunda" = pr\xF3xima segunda-feira a partir de hoje
- "amanh\xE3" = pr\xF3ximo dia a partir de hoje
- "\xE0s 15" = 15:00 no fuso ${e}
- Se n\xE3o especificar hora, use 09:00
- SEMPRE use ano 2025 ou posterior
- Considere que hoje \xE9 ${new Date().toLocaleDateString("pt-BR",{timeZone:e,weekday:"long"})}

Responda APENAS em JSON:
{
  "title": "t\xEDtulo limpo",
  "date": "YYYY-MM-DD",
  "hour": 15,
  "minute": 0,
  "isValid": true
}`,a=await be.post("https://openrouter.ai/api/v1/chat/completions",{model:"anthropic/claude-3-haiku",messages:[{role:"system",content:t},{role:"user",content:`Analise: "${o}"`}],response_format:{type:"json_object"}},{headers:{Authorization:`Bearer ${process.env.OPENROUTER_API_KEY}`,"Content-Type":"application/json","HTTP-Referer":"https://zelar-bot.replit.app","X-Title":"Zelar Calendar Bot"}}),r=JSON.parse(a.data.choices[0].message.content);console.log(`\u{1F916} Claude interpretou: "${o}" \u2192 ${JSON.stringify(r)}`),console.log(`\u{1F50D} [CLAUDE DEBUG] T\xEDtulo retornado: "${r.title}"`);let s=r.date;if(s&&s.startsWith("2023")||s.startsWith("2024")){let n=new Date().getFullYear();s=s.replace(/^\d{4}/,n.toString()),console.log(`\u{1F4C5} Data corrigida de ${r.date} para ${s}`)}return{title:r.title||"Evento",date:s||new Date().toISOString().split("T")[0],hour:r.hour||9,minute:r.minute||0,isValid:r.isValid!==!1}}catch(t){return console.error("Erro ao usar Claude:",t),{title:o.split(" ").slice(0,3).join(" "),date:new Date().toISOString().split("T")[0],hour:9,minute:0,isValid:!1,error:"Falha na interpreta\xE7\xE3o IA"}}}O();import{DateTime as Te}from"luxon";var x="https://api.telegram.org/bot",N=0;function ye(o){let e=new Date(o.startDate),t=new Date(e.getTime()+60*60*1e3),a=n=>n.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z",r=`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(o.title)}&dates=${a(e)}/${a(t)}`,s=`https://outlook.live.com/calendar/0/deeplink/compose?subject=${encodeURIComponent(o.title)}&startdt=${e.toISOString()}&enddt=${t.toISOString()}`;return{google:r,outlook:s}}async function $(o,e,t){try{let a=process.env.TELEGRAM_BOT_TOKEN;return a?(await fetch(`${x}${a}/sendMessage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:o,text:e,parse_mode:"Markdown",reply_markup:t})})).ok:!1}catch(a){return console.error("\u274C Erro ao enviar mensagem:",a),!1}}async function Ae(o,e){try{let t=process.env.TELEGRAM_BOT_TOKEN;return t?(await fetch(`${x}${t}/answerCallbackQuery`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callback_query_id:o,text:e||"",show_alert:!1})})).ok:!1}catch(t){return console.error("\u274C Erro ao responder callback:",t),!1}}async function Ce(o){try{let e=[{command:"start",description:"Iniciar o assistente e ver instru\xE7\xF5es"},{command:"help",description:"Mostrar ajuda completa e exemplos"},{command:"timezone",description:"Alterar fuso hor\xE1rio"}];(await fetch(`${x}${o}/setMyCommands`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({commands:e})})).ok?console.log("\u2705 Comandos configurados no menu do bot"):console.log("\u26A0\uFE0F Falha ao configurar comandos")}catch(e){console.error("\u274C Erro ao configurar comandos:",e)}}async function Ee(){try{let o=process.env.TELEGRAM_BOT_TOKEN;if(!o)return[];let e=await fetch(`${x}${o}/getUpdates?offset=${N+1}&timeout=1`);if(!e.ok)return[];let t=await e.json();return!t.ok||!t.result?[]:t.result}catch(o){return console.error("\u274C Erro ao buscar updates:",o),[]}}async function ve(o){if(o.callback_query){let a=o.callback_query.data,r=o.callback_query.message.chat.id,s=o.callback_query.id;if(console.log(`\u{1F518} Callback: "${a}" do chat ${r}`),a?.startsWith("tz_")){let n={tz_brazil:"America/Sao_Paulo",tz_us_east:"America/New_York",tz_us_central:"America/Chicago",tz_us_west:"America/Los_Angeles",tz_london:"Europe/London",tz_europe:"Europe/Berlin",tz_moscow:"Europe/Moscow",tz_india:"Asia/Kolkata",tz_china:"Asia/Shanghai",tz_japan:"Asia/Tokyo",tz_sydney:"Australia/Sydney",tz_newzealand:"Pacific/Auckland"},i={tz_brazil:"Brasil/Argentina (UTC-3)",tz_us_east:"EUA Leste/Canad\xE1 (UTC-5)",tz_us_central:"EUA Central/M\xE9xico (UTC-6)",tz_us_west:"EUA Oeste (UTC-8)",tz_london:"Londres/Dublin (UTC+0)",tz_europe:"Europa Central (UTC+1)",tz_moscow:"Moscou/Turquia (UTC+3)",tz_india:"\xCDndia (UTC+5:30)",tz_china:"China/Singapura (UTC+8)",tz_japan:"Jap\xE3o/Coreia (UTC+9)",tz_sydney:"Austr\xE1lia Leste (UTC+10)",tz_newzealand:"Nova Zel\xE2ndia (UTC+12)"},c=n[a],p=i[a];c&&(await $(r,`\u2705 *Fuso hor\xE1rio atualizado!*

\u{1F30D} Regi\xE3o: ${p}
\u23F0 Agora todos os eventos ser\xE3o criados neste fuso hor\xE1rio.

\u{1F4A1} Envie uma mensagem como "reuni\xE3o amanh\xE3 \xE0s 14h" para testar!`),await Ae(s,`Fuso hor\xE1rio definido: ${p}`))}return}if(!o.message||!o.message.text)return;let e=o.message.text,t=o.message.chat.id;if(console.log(`\u{1F4E9} Mensagem: "${e}" do chat ${t}`),e==="/start"){await $(t,`\u{1F916} *Zelar - Assistente de Agendamento*

\u{1F4A1} *Como usar:*
\u2022 "jantar hoje \xE0s 19h"
\u2022 "reuni\xE3o amanh\xE3 \xE0s 15h"
\u2022 "consulta sexta \xE0s 10h"

\u{1F30D} *Fuso hor\xE1rio:* Brasil (UTC-3)
Use /timezone para alterar

\u{1F4DD} *Comandos:*
/timezone - Alterar fuso hor\xE1rio
/help - Ajuda completa

Envie qualquer mensagem com data e hor\xE1rio!`);return}if(e==="/help"){await $(t,`\u{1F916} *Assistente Zelar - Ajuda*

\u{1F4C5} *Como usar:*
Envie mensagens naturais como:
\u2022 "reuni\xE3o com cliente amanh\xE3 \xE0s 14h"
\u2022 "jantar com fam\xEDlia sexta \xE0s 19h30"
\u2022 "consulta m\xE9dica ter\xE7a-feira \xE0s 10h"
\u2022 "call de projeto quinta \xE0s 15h"

\u2699\uFE0F *Comandos:*
/timezone - Alterar fuso hor\xE1rio
/start - Mensagem inicial

\u{1F30D} *Fuso atual:* Brasil (UTC-3)

\u2728 Processamento com IA Claude!`);return}if(e==="/timezone"){await $(t,`\u{1F30D} *Selecione seu fuso hor\xE1rio:*

\u{1F1E7}\u{1F1F7} Brasil/Argentina: UTC-3
\u{1F1FA}\u{1F1F8} EUA Leste/Canad\xE1: UTC-5
\u{1F1FA}\u{1F1F8} EUA Central/M\xE9xico: UTC-6
\u{1F1FA}\u{1F1F8} EUA Oeste: UTC-8
\u{1F1EC}\u{1F1E7} Londres/Dublin: UTC+0
\u{1F1EA}\u{1F1FA} Europa Central (Alemanha, Fran\xE7a, It\xE1lia, Espanha): UTC+1
\u{1F1F7}\u{1F1FA} Moscou/Turquia: UTC+3
\u{1F1EE}\u{1F1F3} \xCDndia: UTC+5:30
\u{1F1E8}\u{1F1F3} China/Singapura: UTC+8
\u{1F1EF}\u{1F1F5} Jap\xE3o/Coreia: UTC+9
\u{1F1E6}\u{1F1FA} Austr\xE1lia Leste: UTC+10
\u{1F1F3}\u{1F1FF} Nova Zel\xE2ndia: UTC+12`,{inline_keyboard:[[{text:"\u{1F1E7}\u{1F1F7} Brasil/Argentina (UTC-3)",callback_data:"tz_brazil"},{text:"\u{1F1FA}\u{1F1F8} EUA Leste/Canad\xE1 (UTC-5)",callback_data:"tz_us_east"}],[{text:"\u{1F1FA}\u{1F1F8} EUA Central/M\xE9xico (UTC-6)",callback_data:"tz_us_central"},{text:"\u{1F1FA}\u{1F1F8} EUA Oeste (UTC-8)",callback_data:"tz_us_west"}],[{text:"\u{1F1EC}\u{1F1E7} Londres/Dublin (UTC+0)",callback_data:"tz_london"},{text:"\u{1F1EA}\u{1F1FA} Europa Central (UTC+1)",callback_data:"tz_europe"}],[{text:"\u{1F1F7}\u{1F1FA} Moscou/Turquia (UTC+3)",callback_data:"tz_moscow"},{text:"\u{1F1EE}\u{1F1F3} \xCDndia (UTC+5:30)",callback_data:"tz_india"}],[{text:"\u{1F1E8}\u{1F1F3} China/Singapura (UTC+8)",callback_data:"tz_china"},{text:"\u{1F1EF}\u{1F1F5} Jap\xE3o/Coreia (UTC+9)",callback_data:"tz_japan"}],[{text:"\u{1F1E6}\u{1F1FA} Austr\xE1lia Leste (UTC+10)",callback_data:"tz_sydney"},{text:"\u{1F1F3}\u{1F1FF} Nova Zel\xE2ndia (UTC+12)",callback_data:"tz_newzealand"}]]});return}if(!e.startsWith("/"))try{let a=o.message?.from?.id?.toString()||"unknown",r=M(a),s=await K(e,r);if(!s.isValid){await $(t,`\u274C *N\xE3o consegui entender a data/hora*

\u{1F4A1} *Tente algo como:*
\u2022 "jantar hoje \xE0s 19h"
\u2022 "reuni\xE3o quarta \xE0s 15h"`);return}let n=Te.fromObject({year:parseInt(s.date.split("-")[0]),month:parseInt(s.date.split("-")[1]),day:parseInt(s.date.split("-")[2]),hour:s.hour,minute:s.minute},{zone:r}),i=s.title&&s.title.length>2?s.title:k(e),c={title:i,startDate:n.toISO()||n.toString(),description:i,displayDate:n.toFormat("EEEE, dd 'de' MMMM '\xE0s' HH:mm",{locale:"pt-BR"})},p=ye(c),T={inline_keyboard:[[{text:"\u{1F4C5} Google Calendar",url:p.google},{text:"\u{1F4C5} Outlook",url:p.outlook}]]};await $(t,`\u2705 *Evento criado!*

\u{1F3AF} *${c.title}*
\u{1F4C5} ${c.displayDate}`,T),console.log(`\u2705 Evento criado: ${c.title}`)}catch(a){console.error("\u274C Erro ao processar:",a),await $(t,"\u274C Erro interno. Tente novamente.")}}var B=!1;async function Q(){try{if(!process.env.TELEGRAM_BOT_TOKEN)return console.error("\u274C Token n\xE3o configurado"),!1;if(B)return console.log("\u26A0\uFE0F Bot j\xE1 est\xE1 rodando"),!0;console.log("\u{1F680} Iniciando bot direto...");let o=process.env.TELEGRAM_BOT_TOKEN,e=await fetch(`${x}${o}/getMe`);if(!e.ok)return console.error("\u274C Falha na conex\xE3o com Telegram"),!1;let t=await e.json();console.log(`\u2705 Bot @${t.result.username} conectado!`),await Ce(o),B=!0;let a=setInterval(async()=>{if(!B){clearInterval(a);return}try{let r=await Ee();for(let s of r)s.update_id>N&&(N=s.update_id,await ve(s))}catch(r){console.error("\u274C Erro no polling:",r)}},2e3);return console.log("\u{1F50D} Bot aguardando mensagens..."),!0}catch(o){return console.error("\u274C Erro ao iniciar bot direto:",o),!1}}q();import we from"path";import{fileURLToPath as Se}from"url";var De=Se(import.meta.url),ct=we.dirname(De),w=L();w.use(L.json());w.use(L.urlencoded({extended:!1}));var X=0,j=Date.now();w.use((o,e,t)=>{let a=Date.now(),r=o.path;X++,j=Date.now();let s,n=e.json;e.json=function(i,...c){return s=i,n.apply(e,[i,...c])},e.on("finish",()=>{let i=Date.now()-a;if(r.startsWith("/api")){let c=`${o.method} ${r} ${e.statusCode} in ${i}ms`;s&&(c+=` :: ${JSON.stringify(s)}`),c.length>80&&(c=c.slice(0,79)+"\u2026"),m(c)}}),t()});w.get("/health",(o,e)=>{let t=Date.now()-j;e.json({status:"ok",uptime:Math.floor(t/1e3),requestCount:X,lastRequest:new Date(j).toISOString(),memory:process.memoryUsage(),telegramBot:!!process.env.TELEGRAM_BOT_TOKEN,database:!!process.env.DATABASE_URL})});w.get("/",(o,e)=>{e.json({status:"ok",message:"TelegramScheduler is running!",timestamp:new Date().toISOString(),telegramBot:!!process.env.TELEGRAM_BOT_TOKEN,database:!!process.env.DATABASE_URL})});process.on("uncaughtException",o=>{m(`\u274C ERRO CR\xCDTICO (uncaughtException): ${o.message}`,"error"),m(`Stack: ${o.stack}`,"error")});process.on("unhandledRejection",(o,e)=>{m(`\u274C PROMISE REJECTION: ${o}`,"error"),m(`Promise: ${e}`,"error")});var ke=3e4;process.env.NODE_ENV!=="production"&&import("dotenv/config");(async()=>{await Y(w);let o=$e(w);o.timeout=ke,o.keepAliveTimeout=65e3,o.headersTimeout=66e3;try{m("\u{1F916} Inicializando bot do WhatsApp..."),await v().initialize(),m("\u2705 Bot do WhatsApp inicializado com sucesso!")}catch(t){m(`\u274C Erro ao inicializar bot do WhatsApp: ${t}`,"error")}try{process.env.TELEGRAM_BOT_TOKEN?(m("\u{1F916} Inicializando bot do Telegram..."),await Q(),m("\u2705 Bot do Telegram inicializado com sucesso!")):m("\u26A0\uFE0F TELEGRAM_BOT_TOKEN n\xE3o configurado - bot do Telegram desabilitado")}catch(t){m(`\u274C Erro ao inicializar bot do Telegram: ${t}`,"error")}let e=process.env.PORT||8080;o.listen(e,()=>{m(`\u{1F680} Servidor iniciado na porta ${e}`),m(`\u{1F4CA} Health check: http://localhost:${e}/health`),m(`\u{1F310} Ambiente: ${process.env.NODE_ENV||"development"}`),process.env.TELEGRAM_BOT_TOKEN||m("\u26A0\uFE0F Para ativar o bot do Telegram, configure TELEGRAM_BOT_TOKEN"),process.env.DATABASE_URL||m("\u26A0\uFE0F Para funcionalidades completas, configure DATABASE_URL")}),process.on("SIGTERM",()=>{m("\u{1F6D1} Recebido SIGTERM, encerrando servidor..."),o.close(()=>{m("\u2705 Servidor encerrado com sucesso"),process.exit(0)})}),process.on("SIGINT",()=>{m("\u{1F6D1} Recebido SIGINT, encerrando servidor..."),o.close(()=>{m("\u2705 Servidor encerrado com sucesso"),process.exit(0)})})})();function m(o,e){let t=new Date().toISOString(),a=e?`[${t}] [${e}] ${o}`:`[${t}] ${o}`;console.log(a)}
